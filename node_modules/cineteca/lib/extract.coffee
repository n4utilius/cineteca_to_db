{ parse } = require 'querystring'
{ map, object } = require 'underscore'
{ trim, clean } = require 'underscore.string'
url = require 'url'

get_youtube_id = ($) ->
  $('.botonTrailer')
    .attr('onclick')
    .match(/\/(.{11})(?:\'|\?)/)[1]

table =

  id: (url) ->
    trim parse(url.split("?")[1]).clv

  url: (urlv) ->
    url.parse urlv

  title: ->
    @('.peliculaTitDir').remove()
    clean @('.peliculaTitulo').text()

  schedule: ->
    sche_str = clean @('#horarios p:first-of-type span:last-of-type').text()
    time_list = sche_str.match(/([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]/g);    

  details: ->
    trim @('[id=peliculaFicha]').html()

  synopsis: ->
    $ = this
    el = $('[id=peliculaSinopsis]')
    $('p', el).removeAttr('style')
    el.html()

  img: ->
    url.parse @('[id=peliculaImagen] img').attr('src')

  youtube: ->
    id = get_youtube_id(this)
    "http://www.youtube.com/watch?v=#{id}&iv_load_policy=3" if id

  embed: ->
    id = get_youtube_id(this)
    "http://www.youtube.com/embed/#{id}?autoplay=1&iv_load_policy=3" if id


exports.details = ($, url, day) ->
  #data = url.split("#")
  #url = data[0]
  movie = object map table, (fn, key) ->
    [key, try fn.call $, url]
  movie.day = day.split("=")[1]
  if movie.id then movie else null


